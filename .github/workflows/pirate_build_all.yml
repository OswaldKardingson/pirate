name: Pirated CI - Build and Test all Platforms

on: [push, pull_request]

env:
  srcdir: ./src
  builddir: ./src

jobs:
  build-and-test-linux-x86_64:
    name: Build and Test Pirated Daemon (Linux x86_64)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Compute version string (Linux x86_64)
      run: |
        MAJOR=$(sed -n 's/^#define CLIENT_VERSION_MAJOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        MINOR=$(sed -n 's/^#define CLIENT_VERSION_MINOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        REV=$(sed -n 's/^#define CLIENT_VERSION_REVISION \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        echo "VERSION=$MAJOR.$MINOR.$REV" >> $GITHUB_ENV

    - name: Show commit hash (Linux x86_64)
      run: git rev-parse HEAD

    - name: Install dependencies (Linux x86_64)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool autotools-dev automake pkg-config libssl-dev \
          libevent-dev bsdmainutils python3 libboost-system-dev \
          libboost-filesystem-dev libboost-chrono-dev libboost-program-options-dev \
          libboost-test-dev libboost-thread-dev libcurl4-openssl-dev \
          python3-zmq libsodium-dev bison curl zip dos2unix

    - name: Ensure LF line endings (Linux x86_64)
      shell: bash
      run: |
        echo "Attempting to convert .mk files to LF..."
        find . -type f -name '*.mk' -exec dos2unix {} \;
        echo "Attempting to convert Makefiles to LF..."
        find . -type f -name 'Makefile' -exec dos2unix {} \;
        echo "Attempting to convert .sh files to LF..."
        find . -type f -name '*.sh' -exec dos2unix {} \;
        echo "Conversion attempt finished."

    - name: Display critical file content (Linux x86_64)
      shell: bash
      run: |
        echo "--- Content of depends/funcs.mk (fetch_file_inner) on Linux x86_64 runner ---"
        if [ -f depends/funcs.mk ]; then
          awk '/define fetch_file_inner/,/endef/' depends/funcs.mk
          echo "--- Content of depends/funcs.mk (configure block) on Linux x86_64 runner ---"
          awk '/^\$\(\$(\1)_configured\):/{p=1} p; /^\$\(AT\)touch \$\$@/{p=0}' depends/funcs.mk
        else
          echo "depends/funcs.mk not found."
        fi
        echo "--------------------------------------------------------------------"

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@stable

    - name: Make build script executable
      run: chmod +x zcutil/build.sh
    
    - name: Fetch Zcash Params
      run: ./zcutil/fetch-params.sh

    - name: Prepare for Rust linting
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep
        
    
        
    - name: Build Pirated Daemon (Linux x86_64)
      run: |
        ./zcutil/build.sh -j$(nproc)

    - name: Run C++ tests (Linux x86_64)
      run: make check

    - name: Display test-suite.log on failure (Linux x86_64)
      if: failure()
      run: |
        echo "Attempting to display src/test-suite.log..."
        if [ -f src/test-suite.log ]; then
          cat src/test-suite.log
        else
          echo "src/test-suite.log not found."
          echo "Listing src directory:"
          ls -la src
        fi

    # - name: Run Python utility tests (Linux x86_64)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: ./test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (Linux x86_64)
    #   env:
    #     PATH: "${{ github.workspace }}/src:$PATH"
    #   run: test/functional/test_runner.py --jobs=$(nproc)
        
    - name: Strip and Package CLI bundle (Linux x86_64)
      run: |
        set -euo pipefail
        . /etc/os-release
        UBUNTU_TAG="Ubuntu$(echo "$VERSION_ID" | tr -d '.')"
        OUTDIR="pirate-cli-${UBUNTU_TAG}-v${VERSION}"
        rm -rf "$OUTDIR"
        mkdir -p "$OUTDIR"
        # Copy binaries and helper scripts
        cp src/pirated "$OUTDIR/" \
           src/pirate-cli "$OUTDIR/" \
           src/pirate-tx "$OUTDIR/"
        cp zcutil/fetch-params.sh "$OUTDIR/"
        # Strip to reduce size
        strip "$OUTDIR/pirated" || true
        strip "$OUTDIR/pirate-cli" || true
        strip "$OUTDIR/pirate-tx" || true
        zip -r "${OUTDIR}.zip" "$OUTDIR"
        
    - name: Upload CLI artifact (Linux x86_64)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-cli-ubuntu
        path: pirate-cli-Ubuntu*-v*.zip

  build-and-test-macos-arm64:
    name: Build and Test Pirated Daemon (macOS ARM64)
    runs-on: macos-latest 

    steps:
    - uses: actions/checkout@v3

    - name: Compute version string (macOS ARM64)
      run: |
        MAJOR=$(sed -n 's/^#define CLIENT_VERSION_MAJOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        MINOR=$(sed -n 's/^#define CLIENT_VERSION_MINOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        REV=$(sed -n 's/^#define CLIENT_VERSION_REVISION \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        echo "VERSION=$MAJOR.$MINOR.$REV" >> $GITHUB_ENV

    - name: Install dependencies (macOS)
      run: |
        brew install autoconf automake libtool pkg-config boost zeromq libsodium coreutils python3 curl zip dos2unix

    - name: Ensure LF line endings for Makefiles and scripts (macOS)
      shell: bash
      run: |
        echo "Attempting to convert .mk files to LF..."
        find . -type f -name '*.mk' -exec dos2unix {} \;
        echo "Attempting to convert Makefiles to LF..."
        find . -type f -name 'Makefile' -exec dos2unix {} \;
        echo "Attempting to convert .sh files to LF..."
        find . -type f -name '*.sh' -exec dos2unix {} \;
        echo "Conversion attempt finished."

    - name: Display critical file content (macOS)
      shell: bash
      run: |
        echo "--- Content of depends/funcs.mk (fetch_file_inner) on macOS runner ---"
        if [ -f depends/funcs.mk ]; then
          awk '/define fetch_file_inner/,/endef/' depends/funcs.mk
          echo "--- Content of depends/funcs.mk (configure block) on macOS runner ---"
          awk '/^\$\(\$(\1)_configured\):/{p=1} p; /^\$\(AT\)touch \$\$@/{p=0}' depends/funcs.mk
        else
          echo "depends/funcs.mk not found."
        fi
        echo "--------------------------------------------------------------------"

    - name: Install Rust (stable with aarch64-apple-darwin target)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: Make build script executable
      run: chmod +x zcutil/build-mac.sh

    - name: Fetch Zcash Params
      run: ./zcutil/fetch-params.sh
      
    - name: Prepare for Rust build
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep

    

    - name: Build Pirated Daemon (macOS)
      run: |
        ./zcutil/build-mac.sh -j$(sysctl -n hw.ncpu)

    - name: Run C++ tests (macOS)
      run: make check

    - name: Display config.log on failure (macOS)
      if: failure()
      run: |
        echo "Attempting to display config.log..."
        if [ -f config.log ]; then
          cat config.log
        else
          echo "config.log not found."
          echo "Listing current directory:"
          ls -la
        fi

    # - name: Run Python utility tests (macOS)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: ./test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (macOS)
    #   env:
    #     PATH: "${{ github.workspace }}/src:$PATH"
    #   run: python3 test/functional/test_runner.py --jobs=$(sysctl -n hw.ncpu)
        
    - name: Strip and Package CLI bundle (macOS ARM64)
      run: |
        set -euo pipefail
        OUTDIR="pirate-cli-MacOS-v${VERSION}"
        rm -rf "$OUTDIR"
        mkdir -p "$OUTDIR"
        cp src/pirated "$OUTDIR/" \
           src/pirate-cli "$OUTDIR/" \
           src/pirate-tx "$OUTDIR/"
        cp zcutil/fetch-params.sh "$OUTDIR/"
        strip "$OUTDIR/pirated" || true
        strip "$OUTDIR/pirate-cli" || true
        strip "$OUTDIR/pirate-tx" || true
        zip -r "${OUTDIR}.zip" "$OUTDIR"
        
    - name: Upload CLI artifact (macOS ARM64)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-cli-macos-arm64
        path: pirate-cli-MacOS-v*.zip

  build-and-test-windows:
    name: Build and Test Pirated Daemon (Windows)
    runs-on: windows-latest 

    steps:
    - uses: actions/checkout@v3

    - name: Compute version string (Windows)
      shell: bash
      run: |
        MAJOR=$(sed -n 's/^#define CLIENT_VERSION_MAJOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        MINOR=$(sed -n 's/^#define CLIENT_VERSION_MINOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        REV=$(sed -n 's/^#define CLIENT_VERSION_REVISION \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        echo "VERSION=$MAJOR.$MINOR.$REV" >> $GITHUB_ENV

    - name: Ensure LF line endings for Makefiles and scripts (Windows)
      shell: bash
      run: |
        echo "Attempting to convert .mk files to LF..."
        find . -type f -name '*.mk' -exec dos2unix {} \;
        echo "Attempting to convert Makefiles to LF..."
        find . -type f -name 'Makefile' -exec dos2unix {} \;
        echo "Attempting to convert .sh files to LF..."
        find . -type f -name '*.sh' -exec dos2unix {} \;
        echo "Conversion attempt finished."

    - name: Set up MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64 
        update: true
        path-type: inherit
        install: >-
          git make autoconf automake libtool pkg-config mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-boost mingw-w64-x86_64-python3 mingw-w64-x86_64-openssl 
          mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-curl zip

    - name: Display critical file line endings and content (Windows)
      shell: bash
      run: |
        echo "--- Verifying line endings for depends/funcs.mk (using od -c) ---"
        if [ -f depends/funcs.mk ]; then
          od -c depends/funcs.mk | head -n 30 || true
        else
          echo "depends/funcs.mk not found for od -c."
        fi
        echo "--- Content of depends/funcs.mk (fetch_file_inner) on Windows runner ---"
        if [ -f depends/funcs.mk ]; then
          awk '/define fetch_file_inner/,/endef/' depends/funcs.mk
          echo "--- Content of depends/funcs.mk (configure block) on Windows runner ---"
          awk '/^\$\(\$(\1)_configured\):/{p=1} p; /^\$\(AT\)touch \$\$@/{p=0}' depends/funcs.mk
        else
          echo "depends/funcs.mk not found for awk."
        fi
        echo "-----------------------------------------------------------------"

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@stable
    - name: Expose Cargo on Windows PATH for all shells
      run: |
        echo "$Env:USERPROFILE\.cargo\bin" | Out-File -FilePath $Env:GITHUB_PATH -Encoding utf8 -Append
        "CARGO_HOME=$Env:USERPROFILE\.cargo" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

    - name: Mount Windows Cargo into MSYS2 and Setup for Depends
      shell: msys2 {0}
      run: |
        # Set up MSYS2 environment with cargo
        mkdir -p "$HOME"
        # Skipping symlink; rely on CARGO_HOME and PATH instead
        
        # Set up cargo environment variables for MSYS2
        export CARGO_HOME=$(cygpath -u "$USERPROFILE")/.cargo
        export PATH="$CARGO_HOME/bin:$PATH"
        
        echo "=== Cargo Environment Setup ==="
        echo "CARGO_HOME: $CARGO_HOME"
        echo "PATH: $PATH"
        
        # Verify cargo is accessible
        echo "=== Cargo Verification ==="
        which cargo || echo "cargo not found in PATH"
        if command -v cargo >/dev/null 2>&1; then
          cargo --version
          echo "Cargo is accessible via PATH"
        else
          echo "ERROR: Cargo not accessible via PATH"
          exit 1
        fi
        
        # Ensure cargo will be available for the depends system
        echo "=== Setting up cargo for depends system ==="
        mkdir -p depends/x86_64-w64-mingw64/native/bin
        
        # Find and copy cargo binary
        CARGO_BINARY=""
        if [ -f "$CARGO_HOME/bin/cargo.exe" ]; then
          CARGO_BINARY="$CARGO_HOME/bin/cargo.exe"
        elif [ -f "$CARGO_HOME/bin/cargo" ]; then
          CARGO_BINARY="$CARGO_HOME/bin/cargo"
        elif command -v cargo >/dev/null 2>&1; then
          CARGO_BINARY=$(which cargo)
        fi
        
        if [ -n "$CARGO_BINARY" ] && [ -f "$CARGO_BINARY" ]; then
          echo "Copying cargo binary to depends location: $CARGO_BINARY"
          cp "$CARGO_BINARY" depends/x86_64-w64-mingw64/native/bin/cargo
          chmod +x depends/x86_64-w64-mingw64/native/bin/cargo
          echo "Cargo setup complete"
          
          # Verify the setup
          depends/x86_64-w64-mingw64/native/bin/cargo --version
        else
          echo "ERROR: Cannot find a valid cargo binary"
          exit 1
        fi
        
        # Make cargo available globally for all subsequent steps
        echo "CARGO_HOME=$CARGO_HOME" >> $GITHUB_ENV
        echo "$CARGO_HOME/bin" >> $GITHUB_PATH
        echo "$(pwd)/depends/x86_64-w64-mingw64/native/bin" >> $GITHUB_PATH

    - name: Make build script executable and Fetch Zcash Params (Windows)
      shell: msys2 {0}
      run: |
        chmod +x zcutil/build-win.sh
        ./zcutil/fetch-params.sh
        
    - name: Prepare for Rust build (Windows)
      shell: msys2 {0}
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep
        
    

    - name: Install build dependencies (Windows)
      shell: msys2 {0}
      run: |
        pacman -S --noconfirm --needed \
          mingw-w64-x86_64-toolchain \
          mingw-w64-x86_64-cmake \
          mingw-w64-x86_64-boost \
          mingw-w64-x86_64-openssl \
          mingw-w64-x86_64-libevent \
          mingw-w64-x86_64-zeromq \
          mingw-w64-x86_64-miniupnpc \
          mingw-w64-x86_64-protobuf \
          mingw-w64-x86_64-qrencode \
          mingw-w64-x86_64-libsodium \
          curl \
          unzip \
          zip \
          patch

    - name: Prepare directories for Windows build
      shell: msys2 {0}
      run: |
        echo "--- Creating necessary directories for Windows build ---"
        mkdir -p depends/sources/download-stamps
        mkdir -p depends/work/download/native_ccache-3.7.4
        mkdir -p depends/work/build
        mkdir -p depends/SDKs
        mkdir -p depends/sdk-sources
        echo "--- Directories created ---"
        
    
        
    - name: Debug Make in MSYS2 (Windows)
      shell: msys2 {0}
      run: |
        # Set up cargo for this step
        mkdir -p "$HOME"
        # Skipping symlink; rely on CARGO_HOME and PATH instead
        export CARGO_HOME=$(cygpath -u "$USERPROFILE")/.cargo
        export PATH="$CARGO_HOME/bin:$PATH"
        
        # Ensure cargo is available for depends
        mkdir -p depends/x86_64-w64-mingw64/native/bin
        if command -v cargo >/dev/null 2>&1; then
          cp "$(which cargo)" depends/x86_64-w64-mingw64/native/bin/cargo
          chmod +x depends/x86_64-w64-mingw64/native/bin/cargo
          echo "Cargo available at: $(which cargo)"
          depends/x86_64-w64-mingw64/native/bin/cargo --version
        else
          echo "ERROR: Cargo not found"
          exit 1
        fi
        
        echo "--- Debugging make command ---"
        cd depends
        echo "Current directory: $(pwd)"
        echo "Listing directory contents:"
        ls -la
        echo "Output of 'type make':"
        type make
        echo "Attempting to run 'make --version':"
        make --version
        echo "Value of build_DOWNLOAD variable (safe query):"
        make -Rrqp HOST=x86_64-w64-mingw64 2>/dev/null | sed -n 's/^build_DOWNLOAD\s*=.*/&/p' | cat || true
        echo "Inspecting make database safely (no recipe execution):"
        # Print the computed database and variables without triggering any recipes
        make -Rrqp HOST=x86_64-w64-mingw64 2>/dev/null | sed -n '1,200p' | cat || true
        echo "--- End Debugging make command ---"
        cd ..

    - name: Build Pirated Daemon (Windows)
      shell: msys2 {0}
      run: |
        # Set up cargo for this step
        mkdir -p "$HOME"
        # Skipping symlink; rely on CARGO_HOME and PATH instead
        export CARGO_HOME=$(cygpath -u "$USERPROFILE")/.cargo
        export PATH="$CARGO_HOME/bin:$PATH"
        
        # Ensure cargo is available for depends
        mkdir -p depends/x86_64-w64-mingw64/native/bin
        if command -v cargo >/dev/null 2>&1; then
          cp "$(which cargo)" depends/x86_64-w64-mingw64/native/bin/cargo
          chmod +x depends/x86_64-w64-mingw64/native/bin/cargo
          echo "Cargo available at: $(which cargo)"
          depends/x86_64-w64-mingw64/native/bin/cargo --version
        else
          echo "ERROR: Cargo not found"
          exit 1
        fi
        
        # Set environment variables to help with downloads
        export CURL_RETRIES=5
        export DOWNLOAD_CONNECT_TIMEOUT=30
        export DOWNLOAD_TIMEOUT=600
        
        # Build with more verbose output and fewer jobs to avoid resource issues
        ./zcutil/build-win.sh -j2 V=1

    - name: Run C++ tests (Windows)
      shell: msys2 {0}
      run: make check

    # - name: Run Python utility tests (Windows)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   shell: msys2 {0}
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (Windows)
    #   env:
    #     PATH: "/c/hostedtoolcache/windows/Python/3.9.9/x64:/d/a/pirate/pirate/src:/mingw64/bin:/usr/bin"
    #   shell: msys2 {0}
    #   run: python3 test/functional/test_runner.py --jobs=$(nproc)
        
    - name: Strip and Package CLI bundle (Windows)
      shell: msys2 {0}
      run: |
        set -euo pipefail
        OUTDIR="pirate-cli-windows-v${VERSION}"
        rm -rf "$OUTDIR"
        mkdir -p "$OUTDIR"
        cp src/pirated.exe "$OUTDIR/" \
           src/pirate-cli.exe "$OUTDIR/" \
           src/pirate-tx.exe "$OUTDIR/"
        cp zcutil/wget64.exe "$OUTDIR/"
        cp zcutil/fetch-params.bat "$OUTDIR/"
        strip "$OUTDIR/pirated.exe" || true
        strip "$OUTDIR/pirate-cli.exe" || true
        strip "$OUTDIR/pirate-tx.exe" || true
        zip -r "${OUTDIR}.zip" "$OUTDIR"
        
    - name: Upload CLI artifact (Windows)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-cli-windows
        path: pirate-cli-windows-v*.zip

  build-daemon-linux-aarch64:
    name: Build Pirated Daemon (Linux AArch64 Cross-Compile)
    runs-on: ubuntu-latest 

    steps:
    - uses: actions/checkout@v3

    - name: Compute version string (Linux AArch64)
      run: |
        MAJOR=$(sed -n 's/^#define CLIENT_VERSION_MAJOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        MINOR=$(sed -n 's/^#define CLIENT_VERSION_MINOR \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        REV=$(sed -n 's/^#define CLIENT_VERSION_REVISION \([0-9][0-9]*\).*/\1/p' src/clientversion.h)
        echo "VERSION=$MAJOR.$MINOR.$REV" >> $GITHUB_ENV

    - name: Show commit hash (Linux AArch64)
      run: git rev-parse HEAD

    - name: Install dependencies (Ubuntu for AArch64 cross-compile)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential pkg-config autoconf libtool automake bsdmainutils \
          python3 curl g++-aarch64-linux-gnu gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu zip dos2unix

    - name: Ensure LF line endings (Linux AArch64)
      shell: bash
      run: |
        echo "Attempting to convert .mk files to LF..."
        find . -type f -name '*.mk' -exec dos2unix {} \;
        echo "Attempting to convert Makefiles to LF..."
        find . -type f -name 'Makefile' -exec dos2unix {} \;
        echo "Attempting to convert .sh files to LF..."
        find . -type f -name '*.sh' -exec dos2unix {} \;
        echo "Conversion attempt finished."

    - name: Display critical file content (Linux AArch64)
      shell: bash
      run: |
        echo "--- Content of depends/funcs.mk (fetch_file_inner) on Linux AArch64 runner ---"
        if [ -f depends/funcs.mk ]; then
          awk '/define fetch_file_inner/,/endef/' depends/funcs.mk
          echo "--- Content of depends/funcs.mk (configure block) on Linux AArch64 runner ---"
          awk '/^\$\(\$(\1)_configured\):/{p=1} p; /^\$\(AT\)touch \$\$@/{p=0}' depends/funcs.mk
        else
          echo "depends/funcs.mk not found."
        fi
        echo "--------------------------------------------------------------------"

    - name: Install Rust (stable, AArch64 target)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-unknown-linux-gnu

    - name: Verify and ensure AArch64 target is available
      run: |
        # Verify target is installed
        echo "=== Rust toolchain info ==="
        rustup show
        echo "=== Installed targets ==="
        rustup target list --installed
        echo "=== Checking for AArch64 target ==="
        if rustup target list --installed | grep -q aarch64-unknown-linux-gnu; then
          echo "AArch64 target found"
        else
          echo "AArch64 target not found, installing..."
          rustup target add aarch64-unknown-linux-gnu
          rustup target list --installed | grep aarch64-unknown-linux-gnu
        fi
        echo "=== Final verification ==="
        rustc --print target-list | grep aarch64-unknown-linux-gnu
        echo "AArch64 target setup complete"

    - name: Make build script executable
      run: chmod +x zcutil/build-arm.sh

    - name: Prepare for Rust build
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep

    - name: Configure Cargo target for Linux AArch64
      run: |
        # Minimal .cargo/config for AArch64, patching bellman & setting target
        rm -f .cargo/config
        echo "# Minimal Cargo config for AArch64" > .cargo/config
        echo "[target.aarch64-unknown-linux-gnu]" >> .cargo/config
        echo "linker = \"aarch64-linux-gnu-gcc\"" >> .cargo/config
        echo "ar = \"aarch64-linux-gnu-ar\"" >> .cargo/config
        cat .cargo/config

    - name: Build Pirated Daemon (AArch64 Cross-Compile)
      env:
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_AR: aarch64-linux-gnu-ar
        CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
        CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
        AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
        RUSTFLAGS: --cfg=rust_secp_no_symbol_renaming -L native=/home/runner/work/pirate/pirate/src/secp256k1/.libs
      run: |
        # Ensure cargo is available for the depends system
        CARGO_BIN_PATH="$(command -v cargo)"
        if [ -z "$CARGO_BIN_PATH" ]; then
          echo "ERROR: Cargo binary not found in PATH" >&2
          exit 1
        fi
        echo "Found cargo at: $CARGO_BIN_PATH"
        # Verify the target is installed
        rustup target list --installed | grep aarch64-unknown-linux-gnu || {
          echo "ERROR: aarch64-unknown-linux-gnu target not found"
          rustup target list --installed
          exit 1
        }
        # Ensure cargo is available when depends system needs it by creating symlinks
        mkdir -p depends/aarch64-linux-gnu/native/bin
        ln -sf "$CARGO_BIN_PATH" depends/aarch64-linux-gnu/native/bin/cargo
        ./zcutil/build-arm.sh -j$(nproc)
        
    - name: Run C++ tests (Linux AArch64)
      if: ${{ false }}
      run: make check

    - name: Display test-suite.log on failure (Linux AArch64)
      if: failure()
      run: |
        echo "Attempting to display src/test-suite.log..."
        if [ -f src/test-suite.log ]; then
          cat src/test-suite.log
        else
          echo "src/test-suite.log not found."
          echo "Listing src directory:"
          ls -la src
        fi

    - name: Run Python utility tests (Linux AArch64)
      if: ${{ false }}
      env:
        PYTHONPATH: ./src/test 
        SRCDIR: ./src
        BUILDDIR: ./src 
      run: |
        python3 src/test/bitcoin-util-test.py
        python3 src/test/wallet-utility.py

    - name: Run Python functional tests (Linux AArch64)
      if: ${{ false }}
      env:
        PATH: "${{ github.workspace }}/src:$PATH"
      run: test/functional/test_runner.py --jobs=$(nproc)
        
    - name: Strip and Package CLI bundle (AArch64)
      run: |
        set -euo pipefail
        OUTDIR="pirate-cli-aarch64-v${VERSION}"
        rm -rf "$OUTDIR"
        mkdir -p "$OUTDIR"
        cp src/pirated "$OUTDIR/" \
           src/pirate-cli "$OUTDIR/" \
           src/pirate-tx "$OUTDIR/"
        cp zcutil/fetch-params.sh "$OUTDIR/"
        aarch64-linux-gnu-strip "$OUTDIR/pirated" || true
        aarch64-linux-gnu-strip "$OUTDIR/pirate-cli" || true
        aarch64-linux-gnu-strip "$OUTDIR/pirate-tx" || true
        zip -r "${OUTDIR}.zip" "$OUTDIR"
        
    - name: Upload CLI artifact (Linux AArch64)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-cli-aarch64
        path: pirate-cli-aarch64-v*.zip

  # --- QT GUI Build and Test Jobs ---

  build-and-test-qt-linux-x86_64:
    name: Build and Test Treasure Chest (Linux x86_64)
    runs-on: ubuntu-latest
    needs: build-and-test-linux-x86_64
    if: success()

    steps:
    - uses: actions/checkout@v3

    - name: Install QT and other dependencies (Linux x86_64)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential libtool autotools-dev automake pkg-config libssl-dev \
          libevent-dev bsdmainutils python3 libboost-system-dev \
          libboost-filesystem-dev libboost-chrono-dev libboost-program-options-dev \
          libboost-test-dev libboost-thread-dev libcurl4-openssl-dev \
          python3-zmq libsodium-dev bison curl \
          qtbase5-dev qttools5-dev qttools5-dev-tools qtchooser qt5-qmake libqt5svg5-dev zip

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@stable

    - name: Make QT build script executable
      run: chmod +x zcutil/build-qt-linux.sh
    
    - name: Fetch Zcash Params
      run: ./zcutil/fetch-params.sh
      
    - name: Prepare for Rust build
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep

    

    - name: Build Treasure Chest (Linux x86_64)
      run: |
        ./zcutil/build-qt-linux.sh -j$(nproc) 

    - name: Run C++ tests (QT Build - Linux x86_64)
      run: make check

    # - name: Run Python utility tests (QT Build - Linux x86_64)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: ./test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (QT Build - Linux x86_64)
    #   env:
    #     PATH: "${{ github.workspace }}/src:$PATH"
    #   run: test/functional/test_runner.py --jobs=$(nproc)
        
    - name: Strip and Zip Qt (Linux x86_64)
      run: |
        if [ -f pirate-qt-linux ]; then strip pirate-qt-linux || true; fi
        . /etc/os-release
        UBUNTU_TAG="Ubuntu$(echo "$VERSION_ID" | tr -d '.')"
        zip --junk-paths "pirate-qt-${UBUNTU_TAG}-v${VERSION}.zip" pirate-qt-linux

    - name: Build Debian package (Ubuntu Qt)
      run: |
        mkdir -p release
        cp pirate-qt-linux release/pirate-qt-linux
        APP_VERSION=${VERSION} zcutil/create-deb-packages.sh
        
    - name: Upload Qt artifacts (Linux x86_64)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-qt-ubuntu
        path: |
          pirate-qt-Ubuntu*-v*.zip
          release/pirate-qt-ubuntu*-v*.deb

  build-and-test-qt-macos-arm64:
    name: Build and Test Treasure Chest (macOS-ARM64)
    runs-on: macos-latest 
    needs: build-and-test-macos-arm64
    if: success()

    steps:
    - uses: actions/checkout@v3

    - name: Install QT and other dependencies (macOS)
      run: |
        brew install autoconf automake libtool pkg-config boost zeromq libsodium coreutils python3 curl qt@5 zip
        echo "/usr/local/opt/qt@5/bin" >> $GITHUB_PATH

    - name: Install Rust (stable with aarch64-apple-darwin target)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-apple-darwin

    - name: Make QT build script executable
      run: chmod +x zcutil/build-qt-mac.sh

    - name: Fetch Zcash Params
      run: ./zcutil/fetch-params.sh
      
    - name: Prepare for Rust build
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep

    

    - name: Build Treasure Chest (macOS)
      run: |
        ./zcutil/build-qt-mac.sh -j$(sysctl -n hw.ncpu)
        # build-qt-mac.sh calls makeReleaseMac.sh which creates the .app / .dmg

    - name: Run C++ tests (QT Build - macOS)
      run: make check

    # - name: Run Python utility tests (QT Build - macOS)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: ./test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (QT Build - macOS)
    #   env:
    #     PATH: "${{ github.workspace }}/src:$PATH"
    #   run: python3 test/functional/test_runner.py --jobs=$(sysctl -n hw.ncpu)
        
    - name: Zip Qt (macOS)
      run: |
        if [ -f pirate-qt-mac.dmg ]; then
          mv pirate-qt-mac.dmg "pirate-qt-MacOS-v${VERSION}.dmg"
        elif [ -f pirate-qt-mac ]; then
          zip --junk-paths "pirate-qt-MacOS-v${VERSION}.zip" pirate-qt-mac
        else
          echo "No macOS Qt artifact found"; exit 1
        fi
        
    - name: Upload Qt artifact (macOS)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-qt-macos
        path: |
          pirate-qt-MacOS-v*.dmg
          pirate-qt-MacOS-v*.zip

  build-and-test-qt-windows:
    name: Build and Test Treasure Chest (Windows)
    runs-on: windows-latest 
    needs: build-and-test-windows
    if: success()

    steps:
    - uses: actions/checkout@v3

    - name: Install QT and other dependencies (Windows)
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW64 
        update: true
        path-type: inherit
        install: >-
          git make autoconf automake libtool pkg-config mingw-w64-x86_64-toolchain
          mingw-w64-x86_64-boost mingw-w64-x86_64-python3 mingw-w64-x86_64-openssl 
          mingw-w64-x86_64-zeromq mingw-w64-x86_64-libsodium mingw-w64-x86_64-curl 
          mingw-w64-x86_64-qt5 zip

    - name: Install Rust (stable)
      uses: dtolnay/rust-toolchain@stable

    - name: Mount Windows Cargo into MSYS2 and Setup for Depends (QT)
      shell: msys2 {0}
      run: |
        # Set up MSYS2 environment with cargo for QT build
        mkdir -p "$HOME"
        ln -sf "$(cygpath -u "$USERPROFILE")/.cargo" "$HOME/.cargo"
        
        # Set up cargo environment variables for MSYS2
        export CARGO_HOME=$(cygpath -u "$USERPROFILE")/.cargo
        export PATH="$CARGO_HOME/bin:$PATH"
        
        echo "=== Cargo Environment Setup (QT) ==="
        echo "CARGO_HOME: $CARGO_HOME"
        echo "PATH: $PATH"
        
        # Verify cargo is accessible
        echo "=== Cargo Verification ==="
        which cargo || echo "cargo not found in PATH"
        if command -v cargo >/dev/null 2>&1; then
          cargo --version
          echo "Cargo is accessible via PATH"
        else
          echo "ERROR: Cargo not accessible via PATH"
          exit 1
        fi
        
        # Ensure cargo will be available for the depends system
        echo "=== Setting up cargo for depends system (QT) ==="
        mkdir -p depends/x86_64-w64-mingw64/native/bin
        
        # Find and copy cargo binary
        CARGO_BINARY=""
        if [ -f "$CARGO_HOME/bin/cargo.exe" ]; then
          CARGO_BINARY="$CARGO_HOME/bin/cargo.exe"
        elif [ -f "$CARGO_HOME/bin/cargo" ]; then
          CARGO_BINARY="$CARGO_HOME/bin/cargo"
        elif command -v cargo >/dev/null 2>&1; then
          CARGO_BINARY=$(which cargo)
        fi
        
        if [ -n "$CARGO_BINARY" ] && [ -f "$CARGO_BINARY" ]; then
          echo "Copying cargo binary to depends location: $CARGO_BINARY"
          cp "$CARGO_BINARY" depends/x86_64-w64-mingw64/native/bin/cargo
          chmod +x depends/x86_64-w64-mingw64/native/bin/cargo
          echo "Cargo setup complete"
          
          # Verify the setup
          depends/x86_64-w64-mingw64/native/bin/cargo --version
        else
          echo "ERROR: Cannot find a valid cargo binary"
          exit 1
        fi
        
        # Make cargo available globally for all subsequent steps
        echo "CARGO_HOME=$CARGO_HOME" >> $GITHUB_ENV
        echo "$CARGO_HOME/bin" >> $GITHUB_PATH
        echo "$(pwd)/depends/x86_64-w64-mingw64/native/bin" >> $GITHUB_PATH

    - name: Make QT build script executable and Fetch Zcash Params (Windows)
      shell: msys2 {0}
      run: |
        chmod +x zcutil/build-qt-win.sh
        ./zcutil/fetch-params.sh
        
    - name: Prepare for Rust build
      shell: msys2 {0}
      run: |
        mkdir -p vendored-sources
        touch vendored-sources/.keep
        
    

    - name: Build Treasure Chest (Windows)
      shell: msys2 {0} 
      run: |
        # Set up cargo for this step
        mkdir -p "$HOME"
        ln -sf "$(cygpath -u "$USERPROFILE")/.cargo" "$HOME/.cargo"
        export CARGO_HOME=$(cygpath -u "$USERPROFILE")/.cargo
        export PATH="$CARGO_HOME/bin:$PATH"
        
        # Ensure cargo is available for depends
        mkdir -p depends/x86_64-w64-mingw64/native/bin
        if command -v cargo >/dev/null 2>&1; then
          cp "$(which cargo)" depends/x86_64-w64-mingw64/native/bin/cargo
          chmod +x depends/x86_64-w64-mingw64/native/bin/cargo
          echo "Cargo available at: $(which cargo)"
          depends/x86_64-w64-mingw64/native/bin/cargo --version
        else
          echo "ERROR: Cargo not found"
          exit 1
        fi
        
        ./zcutil/build-qt-win.sh -j$(nproc)

    - name: Run C++ tests (QT Build - Windows)
      shell: msys2 {0}
      run: make check

    # - name: Run Python utility tests (QT Build - Windows)
    #   working-directory: src
    #   env:
    #     PYTHONPATH: test
    #     SRCDIR: ./
    #     BUILDDIR: ./
    #   shell: msys2 {0}
    #   run: |
    #     python3 test/wallet-utility.py

    # - name: Run Python functional tests (QT Build - Windows)
    #   env:
    #     PATH: "/c/hostedtoolcache/windows/Python/3.9.9/x64:/d/a/pirate/pirate/src:/mingw64/bin:/usr/bin"
    #   shell: msys2 {0}
    #   run: python3 test/functional/test_runner.py --jobs=$(nproc)
        
    - name: Strip and Zip Qt (Windows)
      shell: msys2 {0}
      run: |
        if [ -f pirate-qt-win.exe ]; then
          strip pirate-qt-win.exe || true
          zip --junk-paths "pirate-qt-windows-v${VERSION}.zip" pirate-qt-win.exe
        else
          echo "pirate-qt-win.exe not found"; exit 1
        fi
        
    - name: Upload Qt artifact (Windows)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-qt-windows
        path: pirate-qt-windows-v*.zip

  build-qt-linux-aarch64:
    name: Build Treasure Chest (Linux AArch64 Cross-Compile)
    runs-on: ubuntu-latest 
    needs: build-daemon-linux-aarch64
    if: success()

    steps:
    - uses: actions/checkout@v3

    - name: Install Rust (stable with aarch64-unknown-linux-gnu target)
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-unknown-linux-gnu

    - name: Install QT and other dependencies (Ubuntu for AArch64 cross-compile)
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          libtool \
          autotools-dev \
          automake \
          pkg-config \
          libssl-dev \
          libevent-dev \
          bsdmainutils \
          python3 \
          python3-pip \
          libboost-system-dev \
          libboost-filesystem-dev \
          libboost-chrono-dev \
          libboost-program-options-dev \
          libboost-test-dev \
          libboost-thread-dev \
          libminiupnpc-dev \
          libzmq3-dev \
          libqrencode-dev \
          qtbase5-dev \
          qttools5-dev-tools \
          libqt5svg5-dev \
          libqt5charts5-dev \
          libprotobuf-dev \
          protobuf-compiler \
          libqrencode-dev \
          g++-aarch64-linux-gnu \
          gcc-aarch64-linux-gnu \
          binutils-aarch64-linux-gnu \
          libc6-dev-arm64-cross

    - name: Configure Cargo target for Linux AArch64 QT
      run: |
        # Minimal .cargo/config for AArch64 QT, patching bellman & setting target
        mkdir -p .cargo
        echo "# Minimal Cargo config for AArch64 QT" > .cargo/config
        echo "[target.aarch64-unknown-linux-gnu]" >> .cargo/config
        echo "linker = \"aarch64-linux-gnu-gcc\"" >> .cargo/config
        echo "ar = \"aarch64-linux-gnu-ar\"" >> .cargo/config

    - name: Build Treasure Chest (AArch64 Cross-Compile)
      env:
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_AR: aarch64-linux-gnu-ar
        CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
        CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++
        AR_aarch64_unknown_linux_gnu: aarch64-linux-gnu-ar
      run: |
        # Ensure cargo is available for the depends system
        CARGO_BIN_PATH="$(command -v cargo)"
        if [ -z "$CARGO_BIN_PATH" ]; then
          echo "ERROR: Cargo binary not found in PATH" >&2
          exit 1
        fi
        echo "Found cargo at: $CARGO_BIN_PATH"
        # Ensure cargo is available when depends system needs it by creating symlinks
        mkdir -p depends/aarch64-linux-gnu/native/bin
        ln -sf "$CARGO_BIN_PATH" depends/aarch64-linux-gnu/native/bin/cargo
        ./zcutil/build-qt-arm.sh -j$(nproc)
        
    - name: Strip and Zip Qt (AArch64)
      run: |
        aarch64-linux-gnu-strip pirate-qt-arm || true
        zip --junk-paths "pirate-qt-aarch64-v${VERSION}.zip" pirate-qt-arm
    
    - name: Build Debian package (AArch64 Qt)
      run: |
        mkdir -p release
        cp pirate-qt-arm release/pirate-qt-arm
        APP_VERSION=${VERSION} zcutil/create-deb-packages.sh
        
    - name: Upload Qt artifacts (Linux AArch64)
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: pirate-qt-aarch64
        path: |
          pirate-qt-aarch64-v*.zip
          release/pirate-qt-aarch64-v*.deb
